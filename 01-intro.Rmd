# Introducción al análisis descriptivo y exploratorio


```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(ggrepel)
library(ggthemes)
source("R/funciones_auxiliares_notas.R")
```


El análisis descriptivo y exploratorio de datos es fundamental en el camino hacia
poder contestar preguntas de interés acerca de un problema de interés. Este tipo
de análisis también juega un papel central en poder contestar:

- ¿Es razonable la pregunta que queremos contestar?
- ¿Podemos contestar la pregunta con los datos que tenemos?

Aunque estas dos preguntas a veces parecen transparentes y simples de contestar,
generalmente no lo son: las preguntas que queremos contestar y los problemas
que queremos resolver son no triviales.

## Formulación de preguntas y respuestas

El proceso de la ciencia de datos no va desde las preguntas
hasta las respuestas en un camino lineal.

En esta gráfica [Roger Peng](https://simplystatistics.org/2019/04/17/tukey-design-thinking-and-better-questions) hay tres caminos: uno es uno ideal que pocas veces sucede,
otro produce respuestas poco útiles pero es fácil, y otro es tortuoso pero que 
caracteriza el mejor trabajo de análisis de datos:


```{r, echo = FALSE, message = FALSE, fig.cap = "Adaptado de R. Peng: Tukey, design thinking and better questions"}
library(tidyverse)
puntos <- tibble(x = c(0.5, 1.2, 4, 4), y = c(0.5, 4, 0.5, 5),
                 etiqueta = c("Dónde\ncomenzamos\nrealmente", "Análisis de datos \n poco útil, de bajo impacto",  "Dónde creeemos \nque comenzamos", "Nuestra\nmeta "))

set.seed(211)

browniano <- tibble(x = 0.5 +  cumsum(c(0,rnorm(50, 0.03, 0.1))) ,
                    y = 0.5 +  cumsum(c(0, rnorm(50, 0.02, 0.2))))
puntos <- 
  bind_rows(puntos, tail(browniano, 1) %>% 
              mutate(etiqueta = "¡¿terminamos!?"))

flechas <- 
  tibble(x = c(0.5, 4), y = c(0.5, 0.5), xend = c(1.2, 4), yend = c(4, 5))

ggplot(puntos, aes(x = x, y = y)) + 
    xlab("Calidad de la pregunta") +
    ylab("Peso de la evidencia") +
    theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
    geom_segment(data = flechas, aes(xend=xend, yend=yend),
                 arrow = arrow(length = unit(0.3, "inches"))) +
    geom_path(data = browniano) +
    geom_point(data = browniano) +
    geom_point(colour="red", size = 5) +
    geom_text(aes(label = etiqueta), vjust = -0.5, hjust = 1.1, size = 4.2) +
    #labs(caption = "Adaptado de R. Peng: Tukey, design thinking and better questions.") +
    xlim(c(-0.1 , 4)) + ylim(c(0,6))
    
```

El proceso típico involucra pasos como los siguientes, y es un proceso **no lineal**:

* Hacer preguntas de la materia que nos interesa
* Recolectar, consumir y procesar los datos para abordarla
* Explorar estos datos y evaluar su calidad
* Hacer análisis o modelos
* Reportar los resultados de forma adecuada y con esto resolver y replantear las preguntas importantes. 

Por ejemplo, evaluar la calidad de los datos puede llevar a replantear la necesidad de obtener más información o de hacer estudios específicos. Así también, los modelos pueden dar luz sobre las preguntas que los originan.


```{block2, type="comentario"}
¿Por dónde empezar el análisis descriptivo y exploratorio? ¿Cómo sabemos que
vamos por buen camino y qué hacer cuando sentimos que nos estancamos?
```

## ¿Cómo saber que vamos en el camino correcto?
 
Comenzamos por discribir cuáles son los signos de calidad del análisis 
que piensa usarse como insumo para una decisión. 
Los principios del diseño analítico de Edward Tufte (@tufte06) son:

Los análisis exitosos:

1. Muestran y explotan **comparaciones**, diferencias y variación.
2. Tienden a ser **multivariados**: estudian conjuntamente más de 1 o 2 variables.
3. Muestran y explotan **estructura sistemática**, sugieren explicaciones. Cuando es posible,
aportan evidencia de causalidad.

También muy importantes pero en los que pondremos menos énfasis:

4. Datos y procesos están bien **documentados**. El análisis es reproducible y transparente.
5. Intentan **integrar** la evidencia completa: texto, explicaciones, tablas y
gráficas.

Y finalmente, el principio general:

6. La calidad, relevancia, e integridad del contenido y los datos son los que
al final sostienen al análisis - por sí mismos, **el uso de técnicas sofisticadas, algoritmos novedosos, uso o no de grandes datos, estilo de visualizaciones o presentaciones no son marcas o sellos de un análisis de datos exitoso**.

```{block2, type="comentario"}
Evaluar un análisis o resultado en estos seis puntos generalmente ayuda en el 
proceso de refinamiento de preguntas y respuestas.
```



## Gráfica de Minard 

La ilustración que Tufte usa para mostrar excelencia en diseño analítico es
una [gráfica de Minard](https://en.wikipedia.org/wiki/Charles_Joseph_Minard) que sirve para entender la campaña de Napoleón (1812) 
en Rusia. Es un ejemplo atípico, pero representa bien los principios y también muestra 
la importancia del ingenio en la construcción de un anállsis:


```{r, echo = FALSE, fig.cap = "Marcha de Napoleón de Charles Minard. Tomado de Wikipedia"}
knitr::include_graphics("figuras/Minard.png")
```

```{block2, type="pregunta"}
¿Cómo satisface los principios del diseño analítico este gráfico?
```




## Ejemplo: Estados y calificaciones en SAT

Una pregunta típica y discutida es: 

```{block2, type="pregunta"}
¿Es cierto que los estados que gastan 
más en educación obtienen los mejores resultados en el SAT?
```

Aunque hay trabajo
considerable en definir estos términos, supongamos que tenemos el
[siguiente conjunto de datos](http://jse.amstat.org/datasets/sat.txt), que son
datos oficiales agregados por estado de Estados Unidos. Tenemos las variables
*sat*, por ejemplo, que es la calificación promedio de los alumnos en cada estado
(para 1997), y la variable *expend*, que es el gasto en miles de dólares
por estudiante en (1994 - 1995), además de algunas otras variables. 


```{r, message = FALSE, echo = FALSE}
sat <- read_csv("datos/sat.csv")

sat_tbl <- sat %>% select(state, expend, sat) %>% 
    gather(variable, valor, expend:sat) %>% 
    group_by(variable) %>% 
    summarise(cuantiles = list(cuantil(valor))) %>% 
    unnest(cols = c(cuantiles)) %>% 
    mutate(valor = round(valor, 1)) %>% 
    spread(cuantil, valor)

sat_tbl %>% formatear_tabla
```


Hay una variación considerable es considerable para promedios del SAT: 
el percentil 75 _de la población de estudiantes_ es alrededor de 1200 puntos, mientras que el 
percentil 25 corresponde a alrededor de 800, 
e igualmente hay diferencias considerables de gasto por alumno (miles de dólares) a lo largo 
de los estados.

*Los percentiles son buenas medidas resumen (mejores que el promedio) porque dan idea de la distribución de los datos (qué valores toman y cuántos datos toman esos valores) y son fácilmente interpretables (en contraste con la media, por ejemplo).*

Ahora hacemos nuestro primer ejercico de comparación: 

* ¿Cómo se ven las
calificaciones para estados por nivel de gasto?

Podemos
usar una gráfica de dispersión:


```{r echo = FALSE}
 ggplot(sat, aes(x = expend, y = sat, label = state)) + 
  geom_smooth(span = 1, method = "loess") +
  geom_point(colour = "red", size = 2) + 
  geom_text_repel(colour = "gray50", size = 3) +
  xlab("Gasto por alumno (miles de dólares)") +
  ylab("Calificación promedio en SAT") 
```

Esta gráfica parece sugerir que los estados en donde el gasto es mayor, 
los resultados promedio del SAT no son tan buenos. Con esto, hemos
contestado la pregunta inicial. 

Este, sin embargo, es un análisis deficiente. De hecho, la
técnica y la respuesta que arroja no son malas.

- **La pregunta, sin embargo, no es una pregunta bien planteada, interesante o útil**.


Después de examinar los datos, descubrimos una variable que puede ser importante: el porcentaje
de alumnos que tomó el SAT en el año dado (*frac*). Podemos agregar al análisis como sigue (el color más claro representa un mayor porcentaje):

```{r echo = FALSE}

ggplot(sat, aes(x = expend, y = sat, label=state, colour = frac,
                 group = frac)) + 
  #geom_smooth(span = 2, alpha = .3, size = 1) + 
  geom_point() + geom_text_repel(size = 3) +
  xlab("Gasto por alumno (miles de dólares)") +
  ylab("Calificación promedio en SAT") +
  scale_color_gradient(low = "coral1", high = "firebrick4")
```


Vemos entonces por qué nuestra comparación inicial es relativamente pobre:
los estados con mejores resultados promedio en el SAT son aquellos donde una
fracción baja de los estudiantes toma el examen. La diferencia
es considerable (de menos de 20% de los alumnos hasta 80%), y la relación
es fuerte:

```{r,  echo = FALSE}
ggplot(sat, aes(x = frac, y = sat, label = state, colour = frac)) + 
  geom_point() +
    geom_smooth(method = "loess", span = 0.5, se = FALSE, method.args = list(degree = 1),
                col = "blue") +
    annotate("text", x = 40, y = 1050, 
             label = "Desempeño por \n encima del esperado", colour = "gray30") +
    annotate("text", x = 15, y = 900, 
             label = "Desempeño por \n abajo del esperado", colour  = "gray30")  +
  theme(legend.position = "none") +
  scale_color_gradient(low = "coral1", high = "firebrick4")

```

Este patrón se observaría cuando los mejores alumnos en cada
estado son los que toman el SAT, aún cuando los estados fueran muy similares
y el gasto no tuviera efecto sobre el desempeño de los alumnos.

Tenemos entonces que replantear nuestra pregunta inicial.

- Pregunta original: ¿será cierto que los estados que gastan 
más en educación son los que obtienen los mejores resultados en el SAT?

- Nueva pregunta: 
**Para estados donde un porcentaje similar de alumnos toma el SAT,
¿mayor gasto en educación está relacionado con mejores resultados en el SAT?**

En este punto podemos hacer varias cosas. Una primera idea es intentar comparar
estados más similares en cuanto a la población de alumnos que asiste. Para esto, hacemos conglomerados con respecto a la fracción de alumnos que presentan el SAT. 

```{r, echo=FALSE, include=FALSE}
set.seed(991)

sat$grupo <- 
  kmeans(sat %>% select(frac), 
                    centers = 4,  nstart = 100, iter.max = 100)$cluster

sat <- 
  sat %>% group_by(grupo) %>% 
  mutate(grupo_mediana_frac = round(median(frac))) %>% 
  ungroup %>% 
  mutate(grupo_mediana_frac = factor(grupo_mediana_frac),
         grupo = as.numeric(grupo_mediana_frac))


 sat %>% 
   group_by(grupo) %>%
   summarise(median_frac = median(frac)) %>%
   arrange(median_frac) %>%
   knitr::kable(format  =  "html",
               digits  =  2,
               format.args  =  list(decimal.mark  =  '.', big.mark  =  ",")) 


```


```{r, echo = TRUE, echo=FALSE, include=FALSE}

sat <- 
  sat %>% mutate(rank_p = rank(frac, ties= "first") / length(frac))

ggplot(sat, aes(x = rank_p, y = frac, label = state, 
                colour = grupo_mediana_frac)) +
  geom_point(size = 2) + 
  #geom_text_repel(colour = "gray80", size = 3) +
  paleta

```

Incluyendo en nuestro análisis el porcentaje de participación, empezamos a ver otra historia. Ajustamos rectas de mínimos cuadrados (regresiones lineales) en cada grupo como referencia:

```{r, echo = FALSE}
ggplot(sat, aes(x = expend, y = sat, label=state, 
                colour = grupo_mediana_frac)) + 
  geom_point(size = 2) + 
  geom_smooth(method = "lm", se = F) +
  xlab("Gasto por alumno (miles)") +
  ylab("Calificación promedio en SAT") + paleta +
  geom_text_repel(colour = "gray70", size = 2) 
```

Y esta comparación intenta responder una pregunta más fina y mejor. 

```{block2, type="pregunta"}
¿Qué nos dice esta gráfica?
```

Este análisis también nos sugiere que la pregunta requiere afinación adicional. 
Podríamos por ejemplo pensar:

- ¿Cómo serían los resultados de un alumno particular si se redujera el gasto del estado? ¿De qué cosas sería privado en su escuela? 
- ¿En qué gastan las escuelas ese dinero? Quizá podemos considerar esos programas
particulares para dar una mejor respuesta.

Son preguntas más difíciles, pero vale más la pena hacer un esfuerzo con contestar
estas preguntas aunque sea aproximadamente, aún cuando no podamos dar una respuesta
precisa y/o simple.

